<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw Agent ä¸å“åº” - è¯Šæ–­å†³ç­–æ ‘</title>
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #d29922;
    --blue: #58a6ff;
    --purple: #bc8cff;
    --orange: #f0883e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    padding: 2rem;
    max-width: 960px;
    margin: 0 auto;
  }
  h1 {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .subtitle {
    color: var(--muted);
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }
  .tree {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .node {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 0;
  }
  .node-header {
    padding: 1rem 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    user-select: none;
    transition: background 0.15s;
  }
  .node-header:hover {
    background: rgba(255,255,255,0.03);
  }
  .step-badge {
    background: var(--blue);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .node-title {
    font-weight: 600;
    font-size: 1.05rem;
    flex: 1;
  }
  .arrow {
    color: var(--muted);
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .node.open .arrow {
    transform: rotate(90deg);
  }
  .node-body {
    display: none;
    padding: 0 1.2rem 1.2rem;
  }
  .node.open .node-body {
    display: block;
  }
  .check {
    background: rgba(88,166,255,0.08);
    border-left: 3px solid var(--blue);
    padding: 0.75rem 1rem;
    border-radius: 0 6px 6px 0;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  .check code {
    background: rgba(255,255,255,0.1);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  .branch {
    margin: 0.75rem 0;
    padding-left: 1rem;
    border-left: 2px solid var(--border);
  }
  .branch-label {
    font-weight: 600;
    margin-bottom: 0.4rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .tag-yes {
    background: rgba(63,185,80,0.15);
    color: var(--green);
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.1rem 0.5rem;
    border-radius: 10px;
  }
  .tag-no {
    background: rgba(248,81,73,0.15);
    color: var(--red);
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.1rem 0.5rem;
    border-radius: 10px;
  }
  .cause {
    background: rgba(248,81,73,0.06);
    border-left: 3px solid var(--red);
    padding: 0.6rem 0.8rem;
    border-radius: 0 6px 6px 0;
    margin: 0.5rem 0;
    font-size: 0.9rem;
  }
  .cause strong { color: var(--red); }
  .fix {
    background: rgba(63,185,80,0.06);
    border-left: 3px solid var(--green);
    padding: 0.6rem 0.8rem;
    border-radius: 0 6px 6px 0;
    margin: 0.5rem 0;
    font-size: 0.9rem;
  }
  .fix strong { color: var(--green); }
  .fix code, .cause code {
    background: rgba(255,255,255,0.1);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.85rem;
  }
  .connector {
    display: flex;
    justify-content: center;
    padding: 0.3rem 0;
  }
  .connector svg {
    width: 24px;
    height: 24px;
    color: var(--muted);
  }
  .next-step {
    color: var(--blue);
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }
  footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.85rem;
    text-align: center;
  }
  footer a { color: var(--blue); text-decoration: none; }
  footer a:hover { text-decoration: underline; }
  @media (max-width: 640px) {
    body { padding: 1rem; }
    h1 { font-size: 1.4rem; }
  }
</style>
</head>
<body>

<h1>OpenClaw Agent ä¸å“åº” â€” è¯Šæ–­å†³ç­–æ ‘</h1>
<p class="subtitle">æŒ‰æ­¥éª¤æ£€æŸ¥ï¼Œå®šä½ agent æ²‰é»˜çš„åŸå› ã€‚ç‚¹å‡»å±•å¼€æ¯ä¸€æ­¥ã€‚</p>

<div class="tree">

<!-- Step 1 -->
<div class="node open" id="step1">
  <div class="node-header" onclick="toggle('step1')">
    <span class="step-badge">Step 1</span>
    <span class="node-title">æ¶ˆæ¯æœ‰ ğŸ‘€ ååº”å—ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong>åœ¨ Discord é¢‘é“é‡Œçœ‹ä½ å‘çš„æ¶ˆæ¯ä¸‹æ–¹æ˜¯å¦å‡ºç° ğŸ‘€ ååº”
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">æ²¡æœ‰ ğŸ‘€</span> æ¶ˆæ¯æ²¡åˆ° OpenClaw</div>
      <div class="cause"><strong>å¯èƒ½åŸå› ï¼š</strong></div>
      <ul style="margin:0.5rem 0 0.5rem 1.5rem; font-size:0.9rem;">
        <li>Discord WebSocket æ–­è¿ï¼ˆcode 1005/1006ï¼‰</li>
        <li><code>groupPolicy</code> ä¸æ˜¯ <code>"open"</code>ï¼Œé¢‘é“ä¸åœ¨ç™½åå•</li>
        <li>Discord token å¤±æ•ˆ / bot ä¸‹çº¿</li>
      </ul>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong><code>openclaw status --deep</code> æŸ¥ Discord çŠ¶æ€ï¼›<code>openclaw gateway restart</code> é‡å¯</div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">æœ‰ ğŸ‘€</span> æ¶ˆæ¯å·²åˆ°è¾¾ OpenClaw</div>
      <p class="next-step">&#8594; è¿›å…¥ Step 2</p>
    </div>
  </div>
</div>

<div class="connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div>

<!-- Step 2 -->
<div class="node" id="step2">
  <div class="node-header" onclick="toggle('step2')">
    <span class="step-badge">Step 2</span>
    <span class="node-title">æ—¥å¿—æœ‰ cli exec å—ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong><code>openclaw logs --max-bytes 20000 | grep "cli exec"</code>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">æ²¡æœ‰ cli exec</span> æ¶ˆæ¯æ²¡æœ‰è§¦å‘ agent</div>
      <div class="cause"><strong>å¯èƒ½åŸå› ï¼š</strong><code>bindings</code> é…ç½®é”™è¯¯ï¼Œé¢‘é“ ID æ²¡æœ‰ç»‘å®šåˆ° agent</div>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>æ£€æŸ¥ <code>openclaw.json</code> çš„ <code>bindings</code> æ•°ç»„ï¼Œç¡®è®¤é¢‘é“ ID å’Œ agentId æ˜ å°„æ­£ç¡®</div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">æœ‰ cli exec</span> Claude CLI å·²è¢«è°ƒç”¨</div>
      <p class="next-step">&#8594; è¿›å…¥ Step 3</p>
    </div>
  </div>
</div>

<div class="connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div>

<!-- Step 3 -->
<div class="node" id="step3">
  <div class="node-header" onclick="toggle('step3')">
    <span class="step-badge">Step 3</span>
    <span class="node-title">cli exec å»¶è¿Ÿå¾ˆä¹…å—ï¼ˆ>30sï¼‰ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong>å¯¹æ¯”æ—¥å¿—ä¸­ <code>cli exec</code> çš„æ—¶é—´æˆ³å’Œ Discord æ¶ˆæ¯å‘é€æ—¶é—´
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">å»¶è¿Ÿ >30s</span> è¢«ä¸²è¡Œé˜Ÿåˆ—é˜»å¡</div>
      <div class="cause"><strong>åŸå› ï¼š</strong><code>cliBackends.serialize</code> é»˜è®¤ <code>true</code>ï¼Œæ‰€æœ‰ agent å…±ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚ä¸€ä¸ª agent å¤„ç†æ…¢ä¼šé˜»å¡å…¶ä»–æ‰€æœ‰ agentã€‚</div>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>åœ¨ <code>openclaw.json</code> çš„ <code>cliBackends.claude-cli</code> ä¸­æ·»åŠ  <code>"serialize": false</code></div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">å¾ˆå¿«å‡ºç°</span> æ²¡æœ‰é˜Ÿåˆ—é˜»å¡</div>
      <p class="next-step">&#8594; è¿›å…¥ Step 4</p>
    </div>
  </div>
</div>

<div class="connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div>

<!-- Step 4 -->
<div class="node" id="step4">
  <div class="node-header" onclick="toggle('step4')">
    <span class="step-badge">Step 4</span>
    <span class="node-title">Claude CLI è¿”å›äº†å“åº”å—ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong><code>openclaw logs --max-bytes 30000 | grep -A2 "cli exec"</code><br>çœ‹ cli exec ä¹‹åæ˜¯å¦æœ‰è¾“å‡ºæ—¥å¿—
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">æ²¡æœ‰å“åº” / æŠ¥é”™</span> Claude CLI æ‰§è¡Œå¤±è´¥</div>
      <div class="cause"><strong>æ’æŸ¥ï¼š</strong></div>
      <ul style="margin:0.5rem 0 0.5rem 1.5rem; font-size:0.9rem;">
        <li>æ‰‹åŠ¨æµ‹è¯•ï¼š<code>echo "test" | claude -p --output-format json</code></li>
        <li>API key / ç½‘ç»œé—®é¢˜</li>
        <li>å†…å­˜ä¸è¶³ï¼š<code>ps aux | grep claude</code></li>
        <li>Session context å¤ªå¤§ï¼ˆè¶… 200k tokenï¼‰â†’ æ¸… session</li>
      </ul>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>æ¸… Claude sessionï¼šåˆ é™¤ <code>~/.claude/projects/-Users-*-openclaw-workspace-*/*.jsonl</code></div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">æœ‰å“åº”</span> CLI æ­£å¸¸è¿”å›</div>
      <p class="next-step">&#8594; è¿›å…¥ Step 5</p>
    </div>
  </div>
</div>

<div class="connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div>

<!-- Step 5 -->
<div class="node" id="step5">
  <div class="node-header" onclick="toggle('step5')">
    <span class="step-badge">Step 5</span>
    <span class="node-title">å“åº”å†…å®¹æ˜¯ HEARTBEAT_OK / NO_REPLY å—ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong>è¯» Claude session æ–‡ä»¶ï¼ŒæŸ¥çœ‹ assistant çš„å®é™…å›å¤<br>
      <code>ls -lt ~/.claude/projects/-Users-*-openclaw-workspace-*/*.jsonl | head -3</code><br>
      ç„¶åè¯»æœ€æ–°çš„ <code>.jsonl</code> æ–‡ä»¶ï¼Œçœ‹ <code>"content":[{"text":"..."}]</code>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">æ˜¯ HEARTBEAT_OK / NO_REPLY</span> è¢« OpenClaw é™é»˜è¿‡æ»¤</div>
      <div class="cause"><strong>åŸå›  1 â€” OpenClaw å†…ç½®æ³¨å…¥ï¼š</strong>å½“ <code>requireMention: false</code> æ—¶ï¼ŒOpenClaw æ³¨å…¥ç³»ç»Ÿæç¤ºï¼š"Be extremely selective: reply only when directly addressed. Otherwise stay silent." + å‘ŠçŸ¥ agent NO_REPLY token</div>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>åœ¨ <code>openclaw.json</code> é¢‘é“é…ç½®ä¸­æ·»åŠ  <code>"systemPrompt": "Dedicated channel. Always respond to every message. Only use NO_REPLY for heartbeat polls."</code></div>

      <div class="cause" style="margin-top:0.75rem;"><strong>åŸå›  2 â€” AGENTS.md è§„åˆ™è¿‡æ¿€ï¼š</strong>"Stay silent (HEARTBEAT_OK) when: It's just casual banter" â€” agent æŠŠæ­£å¸¸æ¶ˆæ¯å½’ç±»ä¸ºé—²èŠ</div>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>æ”¹ AGENTS.md ä¸­ "Stay silent" éƒ¨åˆ†ï¼Œé»˜è®¤ RESPONDï¼Œä»…å¯¹ heartbeat poll é™é»˜</div>

      <div class="cause" style="margin-top:0.75rem;"><strong>åŸå›  3 â€” æ—§ session ç¼“å­˜ï¼š</strong>Claude åœ¨æ—§ session ä¸­å­¦åˆ°äº†é”™è¯¯çš„"æ²‰é»˜"è¡Œä¸ºæ¨¡å¼</div>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>æ¸…ä¸¤å±‚ sessionï¼š<br>
        1. <code>rm ~/.claude/projects/-Users-*-openclaw-workspace-*/*.jsonl</code><br>
        2. æ¯ä¸ª agent çš„ <code>~/.openclaw/agents/*/sessions/sessions.json</code> å†™å…¥ <code>{}</code>
      </div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">æ­£å¸¸æ–‡æœ¬</span> Claude å›å¤äº†æ­£å¸¸å†…å®¹</div>
      <p class="next-step">&#8594; è¿›å…¥ Step 6</p>
    </div>
  </div>
</div>

<div class="connector"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg></div>

<!-- Step 6 -->
<div class="node" id="step6">
  <div class="node-header" onclick="toggle('step6')">
    <span class="step-badge">Step 6</span>
    <span class="node-title">å“åº”é€è¾¾ Discord äº†å—ï¼Ÿ</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="node-body">
    <div class="check">
      <strong>æ£€æŸ¥æ–¹å¼ï¼š</strong>æ—¥å¿—æœ deliver / send ç›¸å…³ä¿¡æ¯ï¼›Discord é¢‘é“æ˜¯å¦æ˜¾ç¤º bot å›å¤
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-no">æ²¡é€è¾¾</span> Discord æŠ•é€’å¤±è´¥</div>
      <div class="cause"><strong>å¯èƒ½åŸå› ï¼š</strong></div>
      <ul style="margin:0.5rem 0 0.5rem 1.5rem; font-size:0.9rem;">
        <li>Bot åœ¨é¢‘é“æ²¡æœ‰ã€Œå‘é€æ¶ˆæ¯ã€æƒé™</li>
        <li>æ¶ˆæ¯è¶…é•¿è¢«æˆªæ–­æˆ–ä¸¢å¼ƒ</li>
        <li>Discord API é™æµ (rate limit)</li>
        <li>WebSocket æ–­è¿</li>
      </ul>
      <div class="fix"><strong>ä¿®å¤ï¼š</strong>æ£€æŸ¥ bot æƒé™ï¼›<code>openclaw gateway restart</code></div>
    </div>

    <div class="branch">
      <div class="branch-label"><span class="tag-yes">å·²é€è¾¾</span> é—®é¢˜å·²è§£å†³</div>
    </div>
  </div>
</div>

</div>

<footer>
  <p>åŸºäº 2026-02-10 å®é™… debug ç»éªŒæ€»ç»“ &middot; OpenClaw + Claude CLI (cliBackend) æ¶æ„</p>
  <p style="margin-top:0.3rem">å¸¸ç”¨å‘½ä»¤ï¼š<code>openclaw status --deep</code> &middot; <code>openclaw logs --max-bytes 20000</code> &middot; <code>openclaw gateway restart</code></p>
</footer>

<script>
function toggle(id) {
  document.getElementById(id).classList.toggle('open');
}
</script>

</body>
</html>
