<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenClaw 诊断报告</title>
<style>
  :root { --bg:#0d1117; --card:#161b22; --border:#30363d; --text:#e6edf3; --muted:#8b949e; --green:#3fb950; --red:#f85149; --yellow:#d29922; --blue:#58a6ff; --cyan:#56d4dd; --purple:#bc8cff; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.6; padding:1.5rem; max-width:1100px; margin:0 auto; }
  h1 { font-size:1.5rem; margin-bottom:0.2rem; }
  .meta { color:var(--muted); font-size:0.85rem; margin-bottom:1rem; }

  .global-bar { display:flex; gap:0.8rem; margin-bottom:1.5rem; flex-wrap:wrap; }
  .g-chip { background:var(--card); border:1px solid var(--border); border-radius:6px; padding:0.4rem 0.8rem; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem; }
  .g-chip.pass { border-color:var(--green); }
  .g-chip.fail { border-color:var(--red); }
  .g-chip .dot { width:8px; height:8px; border-radius:50%; }
  .g-chip.pass .dot { background:var(--green); }
  .g-chip.fail .dot { background:var(--red); }

  .summary { display:flex; gap:1rem; margin-bottom:1.5rem; }
  .summary-card { flex:1; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
  .summary-card.pass { border-color:var(--green); }
  .summary-card.fail { border-color:var(--red); }
  .summary-card.warn { border-color:var(--yellow); }
  .summary-num { font-size:1.8rem; font-weight:800; }
  .summary-card.pass .summary-num { color:var(--green); }
  .summary-card.fail .summary-num { color:var(--red); }
  .summary-card.warn .summary-num { color:var(--yellow); }
  .summary-label { font-size:0.75rem; color:var(--muted); }

  /* Agent selector tabs */
  .agent-tabs { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; }
  .agent-tab { background:var(--card); border:1px solid var(--border); border-radius:6px; padding:0.4rem 1rem; font-size:0.85rem; cursor:pointer; color:var(--muted); transition:all 0.2s; }
  .agent-tab:hover { border-color:var(--blue); color:var(--text); }
  .agent-tab.active { border-color:var(--blue); color:var(--blue); background:rgba(88,166,255,0.08); }
  .agent-tab.all { font-weight:600; }

  /* Agent card */
  .agent-card { background:var(--card); border:1px solid var(--border); border-radius:8px; margin-bottom:0.75rem; overflow:hidden; display:none; }
  .agent-card.visible { display:block; }
  .agent-card.pass { border-left:3px solid var(--green); }
  .agent-card.fail { border-left:3px solid var(--red); }
  .agent-card.warn { border-left:3px solid var(--yellow); }

  .agent-header { display:flex; align-items:center; gap:0.6rem; padding:0.75rem 1rem; cursor:pointer; }
  .agent-header:hover { background:rgba(255,255,255,0.02); }
  .agent-name { font-weight:700; font-size:1rem; color:var(--cyan); min-width:140px; }
  .agent-meta { color:var(--muted); font-size:0.8rem; min-width:160px; }
  .token-bar { flex:1; max-width:120px; height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
  .token-fill { height:100%; border-radius:3px; transition:width 0.3s; }
  .token-fill.green { background:var(--green); }
  .token-fill.yellow { background:var(--yellow); }
  .token-fill.red { background:var(--red); }
  .agent-badge { font-size:0.7rem; font-weight:700; padding:0.15rem 0.5rem; border-radius:10px; }
  .agent-badge.pass { background:rgba(63,185,80,0.15); color:var(--green); }
  .agent-badge.fail { background:rgba(248,81,73,0.15); color:var(--red); }
  .agent-badge.warn { background:rgba(210,153,34,0.15); color:var(--yellow); }
  .arrow { color:var(--muted); transition:transform 0.2s; font-size:0.75rem; margin-left:auto; }
  .agent-card.open .arrow { transform:rotate(90deg); }

  .agent-body { display:none; padding:0 1rem 0.8rem; }
  .agent-card.open .agent-body { display:block; }

  .check { display:flex; align-items:center; gap:0.5rem; padding:0.35rem 0; border-bottom:1px solid rgba(48,54,61,0.5); font-size:0.85rem; }
  .check::before { content:''; width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .check.pass::before { background:var(--green); }
  .check.fail::before { background:var(--red); }
  .check.warn::before { background:var(--yellow); }
  .check-label { font-weight:600; min-width:100px; color:var(--text); }
  .check-detail { color:var(--muted); }

  .error-detail { margin:0.5rem 0; }
  .error-title { font-size:0.75rem; font-weight:600; color:var(--yellow); margin-bottom:0.3rem; }
  .error-analysis { font-size:0.78rem; color:var(--yellow); background:rgba(210,153,34,0.08); border:1px solid rgba(210,153,34,0.2); border-radius:6px; padding:0.5rem 0.8rem; margin-bottom:0.4rem; white-space:pre-line; line-height:1.5; }
  .error-expand { margin-top:0.3rem; }
  .error-expand summary { font-size:0.75rem; font-weight:600; color:var(--muted); cursor:pointer; padding:0.2rem 0; }
  .error-expand summary:hover { color:var(--blue); }
  .error-expand[open] summary { color:var(--blue); }
  .log-block { background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:0.6rem 0.8rem; font-family:'SF Mono',Monaco,Consolas,monospace; font-size:0.72rem; overflow-x:auto; white-space:pre-wrap; word-break:break-all; color:var(--muted); max-height:250px; overflow-y:auto; }

  .conv-list { font-size:0.75rem; color:var(--muted); padding:0.4rem 0; border-bottom:1px solid rgba(48,54,61,0.5); margin-bottom:0.2rem; display:flex; flex-direction:column; gap:0.15rem; }
  .conv-title { font-weight:600; color:var(--text); margin-bottom:0.2rem; }
  .conv-item { padding:0.1rem 0.4rem; border-radius:3px; }
  .conv-item.sel { background:rgba(88,166,255,0.1); color:var(--blue); font-weight:600; }

  .last-msg { font-size:0.8rem; color:var(--muted); padding:0.5rem 0 0.4rem; border-bottom:1px solid rgba(48,54,61,0.5); margin-bottom:0.2rem; }
  .last-msg em { color:var(--text); font-style:normal; }
  .dtree-flow { display:flex; align-items:flex-start; padding:0.6rem 0; margin-bottom:0.4rem; border-bottom:1px solid rgba(48,54,61,0.5); }
  .dtree-step { display:flex; align-items:flex-start; flex:1; min-width:0; }
  .dtree-step:last-child { flex:0 0 auto; }
  .dtree-node { display:flex; flex-direction:column; align-items:center; }
  .dtree-dot { width:14px; height:14px; border-radius:50%; flex-shrink:0; }
  .dtree-node.pass .dtree-dot { background:var(--green); box-shadow:0 0 4px rgba(63,185,80,0.4); }
  .dtree-node.fail .dtree-dot { background:var(--red); box-shadow:0 0 4px rgba(248,81,73,0.4); }
  .dtree-node.warn .dtree-dot { background:var(--yellow); box-shadow:0 0 4px rgba(210,153,34,0.4); }
  .dtree-label { font-size:0.65rem; color:var(--muted); margin-top:0.2rem; white-space:nowrap; }
  .dtree-line { flex:1; height:2px; background:var(--border); margin:6px 4px 0; min-width:8px; }

  footer { margin-top:2rem; padding-top:1rem; border-top:1px solid var(--border); color:var(--muted); font-size:0.75rem; text-align:center; }
  footer a { color:var(--blue); }
</style>
</head>
<body>
<h1>OpenClaw 诊断报告</h1>
<p class="meta">2026-02-11 07:07:41 · Bos-MacBook-Air.local · agents: butler</p>

<div class="global-bar">
  <div class="g-chip pass"><span class="dot"></span>Discord OK</div>
  <div class="g-chip pass"><span class="dot"></span>Gateway reachable</div>
  <div class="g-chip pass"><span class="dot"></span>claude-cli: serialize=False</div>
</div>

<div class="summary">
  <div class="summary-card pass"><div class="summary-num">3</div><div class="summary-label">PASS</div></div>
  <div class="summary-card fail"><div class="summary-num">1</div><div class="summary-label">FAIL</div></div>
  <div class="summary-card warn"><div class="summary-num">1</div><div class="summary-label">WARN</div></div>
</div>

<div class="agent-tabs">
  <div class="agent-tab all active" onclick="filterAgent('all')">全部</div>
  <div class="agent-tab" onclick="filterAgent('butler')">butler</div>
</div>


<div class="agent-card fail" data-agent="butler">
  <div class="agent-header" onclick="toggleAgent(this)">
    <span class="agent-name">butler</span>
    <span class="agent-meta">27m ago · 14k/200k (7%)</span>
    <div class="token-bar"><div class="token-fill green" style="width:7%"></div></div>
    <span class="agent-badge fail">3P 1F 1W</span>
    <span class="arrow">&#9654;</span>
  </div>
  <div class="agent-body">
    <div class="conv-list"><span class="conv-title">对话记录:</span><span class="conv-item">[1] 2026-02-10 22:40:30 — 怎么回事？</span><span class="conv-item sel">[2] 2026-02-10 03:51:07 — list all available MCP tools that start with 'browser'</span></div>
    <div class="last-msg">选中对话 #2: <em>2026-02-10 03:51:07</em> (UTC) — <em>list all available MCP tools that start with 'browser'</em></div>
    <div class="dtree-flow">
      <div class="dtree-step"><div class="dtree-node pass"><div class="dtree-dot"></div><div class="dtree-label">Gateway</div></div><div class="dtree-line"></div></div>
      <div class="dtree-step"><div class="dtree-node pass"><div class="dtree-dot"></div><div class="dtree-label">CLI 调用</div></div><div class="dtree-line"></div></div>
      <div class="dtree-step"><div class="dtree-node pass"><div class="dtree-dot"></div><div class="dtree-label">串行队列</div></div><div class="dtree-line"></div></div>
      <div class="dtree-step"><div class="dtree-node fail"><div class="dtree-dot"></div><div class="dtree-label">CLI 完成</div></div><div class="dtree-line"></div></div>
      <div class="dtree-step"><div class="dtree-node pass"><div class="dtree-dot"></div><div class="dtree-label">静默过滤</div></div><div class="dtree-line"></div></div>
      <div class="dtree-step"><div class="dtree-node warn"><div class="dtree-dot"></div><div class="dtree-label">送达</div></div></div>
    </div>
    <div class="check pass"><span class="check-label">Session 状态</span><span class="check-detail">Token 14k/200k (7%) — 正常, 最近活跃 27m ago</span></div>
    <div class="check pass"><span class="check-label">CLI 活跃</span><span class="check-detail">最近调用: 22:59:42 (488分钟前, 全局 11 条)</span></div>
    <div class="check fail"><span class="check-label">CLI 完成</span><span class="check-detail">发现 2 条 CLI 错误</span></div>
    <div class="error-detail">
      <div class="error-analysis">WebSocket 断连 (1005): Discord 连接中断期间 CLI 请求失败，通常是短暂网络波动，会自动恢复</div>
      <details class="error-expand">
        <summary>展开日志上下文 (±5行)</summary>
        <div class="log-block">2026-02-10T22:35:57.609Z warn [EventQueue] Slow listener detected: DiscordReactionListener took 1815ms for event MESSAGE_REACTION_ADD
2026-02-10T22:35:57.972Z info agent/claude-cli {&quot;subsystem&quot;:&quot;agent/claude-cli&quot;} cli exec: provider=claude-cli model=opus promptChars=185
2026-02-10T22:36:00.982Z info gateway/channels/discord {&quot;subsystem&quot;:&quot;gateway/channels/discord&quot;} discord gateway: Attempting resume with backoff: 1000ms
2026-02-10T22:36:01.221Z info gateway/channels/discord {&quot;subsystem&quot;:&quot;gateway/channels/discord&quot;} discord gateway: WebSocket connection closed with code 1005
2026-02-10T22:36:06.439Z info agent/claude-cli {&quot;subsystem&quot;:&quot;agent/claude-cli&quot;} cli exec: provider=claude-cli model=opus promptChars=701
2026-02-10T22:36:06.488Z error Embedded agent failed before reply: CLI failed.
2026-02-10T22:36:06.497Z error [openclaw] Unhandled promise rejection: FailoverError: CLI failed.
    at file:///opt/homebrew/lib/node_modules/openclaw/dist/reply-DptDUVRg.js:62380:11
2026-02-10T22:36:08.682Z info gateway/canvas {&quot;subsystem&quot;:&quot;gateway/canvas&quot;} canvas host mounted at http://127.0.0.1:18789/__openclaw__/canvas/ (root /Users/bozhu/.openclaw/canvas)
2026-02-10T22:36:08.733Z info gateway/heartbeat {&quot;subsystem&quot;:&quot;gateway/heartbeat&quot;} {&quot;intervalMs&quot;:1800000} heartbeat: started
2026-02-10T22:36:08.736Z info gateway {&quot;subsystem&quot;:&quot;gateway&quot;} agent model: claude-cli/claude-opus-4-6
2026-02-10T22:36:08.737Z info gateway {&quot;subsystem&quot;:&quot;gateway&quot;} listening on ws://127.0.0.1:18789 (PID 3400)</div>
      </details>
    </div>
    <div class="check pass"><span class="check-label">静默过滤</span><span class="check-detail">最后回复: '**[管家]**'</span></div>
    <div class="check warn"><span class="check-label">Discord 送达</span><span class="check-detail">无正向信号也无错误（数据不足）</span></div>
  </div>
</div>

<footer>
  <p>由 <code>diagnose.sh</code> 自动生成 · <a href="index.html">决策树参考</a></p>
</footer>

<script>
function filterAgent(name) {
  document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.agent-card').forEach(c => {
    if (name === 'all' || c.dataset.agent === name) {
      c.classList.add('visible');
    } else {
      c.classList.remove('visible');
    }
  });
}
function toggleAgent(el) {
  el.closest('.agent-card').classList.toggle('open');
}
// Show all on load
document.querySelectorAll('.agent-card').forEach(c => c.classList.add('visible'));
// Auto-expand failed agents
document.querySelectorAll('.agent-card.fail').forEach(c => c.classList.add('open'));
</script>
</body>
</html>
